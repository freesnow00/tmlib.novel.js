tm.asset.Loader.register("ks",function(a){var b=tm.novel.Script(a);return b}),tm.define("tm.novel.Script",{superClass:"tm.event.EventDispatcher",loaded:!1,init:function(a){this.superInit(),this.tasks=[],this.tagTable=[],a&&this.load(a)},load:function(a){this.loaded=!1,this.path=a,tm.util.Ajax.load({url:a,dataType:"text",success:function(a){this.parse(a),this.loaded=!0,this.fire(tm.event.Event("load"))}.bind(this)})},reload:function(){this.load(this.path)},parse:function(a){var b=this,c=this.tasks,d=a.split("\n");return d.each(function(a){var d=a[0];if("*"==d){var e=a.trim(),f=c.length;b.tagTable[e]=f}else if(";"==d);else if("@"==d)c.push(b._makeTag(a.substr(1)));else{for(var g=!1,h="",i="",j=0;j<a.length;++j){var k=a[j];1==g?"]"==k?(c.push(b._makeTag(h)),h="",g=!1):h+=k:0==g&&"["==k?(c.push({type:"text",value:i}),i="",g=!0):i+=k}""!=i&&(c.push({type:"text",value:i}),i="")}}),console.log(c),this},_makeTag:function(a){var b=a.split(" "),c=b.shift(),d={};b.each(function(a){var b=a.split("="),c=b[0],e=b[1];return e.match(/[^0-9]+/)?"true"===e?e=!0:"false"===e&&(e=!1):e=Number(e),d[c]=e});var e={type:"tag",func:c,params:d};return e}}),tm.define("tm.novel.Layer",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.images={}},addImage:function(a,b){this.images[a]=b,this.addChild(b)},getImage:function(a){return this.images[a]},removeImage:function(a){this.images[a].remove(),this.images[a]=null}}),tm.novel.TAG_MAP={l:function(a){a.pointing.getPointingStart()&&this.next()},r:function(){this.labelArea.text+="\n",this.next()},cm:function(){this.labelArea.text="",this.next()},wait:function(a){0==this.waitFlag?(this.waitFlag=!0,this.waitTime=0):(this.waitTime+=1e3/a.fps,this.activeTask.params.time<=this.waitTime&&(this.waitFlag=!1,this.next()))},alert:function(){console.log(this.activeTask.params.str),this.next()},position:function(){var a=this.activeTask.params,b=this.labelArea;void 0!==a.x&&(b.x=a.x),void 0!==a.y&&(b.y=a.y),void 0!==a.width&&(b.width=a.width),void 0!==a.height&&(b.height=a.height),a.vertical===!0&&(b.mode="vertical"),this.next()},font:function(){var a=this.activeTask.params,b=this.labelArea;void 0!==a.size&&(b.fontSize=a.size),void 0!==a.color&&(b.fillStyle=a.color),void 0!==a.face&&(b.fontFamily=a.face),this.next()},load:function(){var a=this.activeTask.params,b=a.type||a.path.split(".").last;this.lock();var c=tm.asset.Loader();c.onload=function(){this.unlock(),this.next()}.bind(this);var d={};d[a.name]={path:a.path,type:b},c.load(d)},image_show:function(){var a=this.activeTask.params,b=tm.display.Sprite(a.name),c=this.layers[a.layer];c.addImage(a.name,b),void 0!==a.x&&(b.x=a.x),void 0!==a.y&&(b.y=a.y),void 0!==a.originX&&(b.originX=a.originX),void 0!==a.originY&&(b.originY=a.originY),void 0!==a.width&&(b.width=a.width),void 0!==a.height&&(b.height=a.height),b.show(),b.alpha=0,b.tweener.clear().fadeIn(250),this.next()},image_hide:function(){var a=this.activeTask.params,b=this.layers[a.layer],c=b.getImage(a.name);c.tweener.clear().fadeOut(250).call(function(){c.hide(),b.removeImage(a.name)}.bind(this)),this.next()},delay:function(a){var b=this.activeTask.params;this.chSpeed=b.speed*(a.fps/1e3)|0,this.chSpeed=Math.max(this.chSpeed,1),this.next()},shape:function(){var a=this.activeTask.params,b=a.type,c=this.layers[a.layer],d=null;switch(b){case"rect":d=tm.display.RectangleShape(a.width,a.height,{strokeStyle:"transparent",fillStyle:a.color});break;default:console.log("そんなタイプないよ!")}c.addImage(a.name,d),d.x=a.x,d.y=a.y,d.alpha=0,d.tweener.clear().fadeIn(250),this.next()},jump:function(){var a=this.activeTask.params;this.jump(a.target)},reload:function(){this.lock(),this.script.reload(),this.script.onload=function(){this.unlock(),this.next()}.bind(this)},call:function(){var a=this.activeTask.params,b=tm.event.Event("novelcall");b.name=a.name,this.fire(b),this.next()},trace:function(){var params=this.activeTask.params;console.log(eval(params.exp)),this.next()},sound_play:function(){var a=this.activeTask.params;tm.asset.Manager.get(a.name).clone().play(),this.next()},music_play:function(){var a=this.activeTask.params;tm.asset.Manager.get(a.name).setLoop(!0).play(),this.next()}},tm.define("tm.novel.Element",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit(),this.script="string"==typeof a?tm.asset.Manager.get(a):a,this.layers={base:tm.novel.Layer().addChildTo(this),0:tm.novel.Layer().addChildTo(this),1:tm.novel.Layer().addChildTo(this),2:tm.novel.Layer().addChildTo(this),message0:tm.novel.Layer().addChildTo(this),message1:tm.novel.Layer().addChildTo(this)},this.taskIndex=0,this.waitFlag=!1,this.lockFlag=!1,this.chSpeed=1,this.labelArea=tm.ui.LabelArea({text:"",width:430,height:200}).addChildTo(this.layers.message0),this.labelArea.text="",this.labelArea.origin.set(0,0),this.labelArea=this.labelArea,this.labelArea.x=10,this.labelArea.y=300,this.labelArea.fontSize=16,this.next()},lock:function(){this.lockFlag=!0},unlock:function(){this.lockFlag=!1},jump:function(a){this.taskIndex=this.script.tagTable[a],this.next()},next:function(){this.activeTask=this.script.tasks[this.taskIndex++],this.seek=0},update:function(a){if(1!=this.lockFlag){var b=this.activeTask;if(b)if("text"==b.type){if(a.frame%this.chSpeed==0){var c=b.value[this.seek++];if(void 0!==c){if(this.labelArea.text+=c,a.pointing.getPointingStart()){for(var d=this.seek,e=b.value.length;e>d;++d){var c=b.value[d];this.labelArea.text+=c}this.next()}}else this.next();var f=tm.event.Event("textupdate");this.fire(f)}}else if("tag"==b.type){var g=tm.novel.TAG_MAP[b.func];console.assert(g,"don't define `{0}`!".format(b.func)),g.call(this,a);var f=tm.event.Event("taskrun");f.task=b,this.fire(f)}else alert()}}});
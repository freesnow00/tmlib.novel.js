tm.asset.Loader.register("ks",function(a){var b=tm.novel.Script(a);return b}),tm.asset.Loader.register("novel",function(a){var b=tm.novel.Script(a);return b}),tm.define("tm.novel.Script",{superClass:"tm.event.EventDispatcher",loaded:!1,init:function(a){this.superInit(),this.tasks=[],this.tagTable=[],a&&this.load(a)},load:function(a){this.loaded=!1,this.path=a,tm.util.Ajax.load({url:a,dataType:"text",success:function(a){this.parse(a),this.loaded=!0,this.fire(tm.event.Event("load"))}.bind(this)})},reload:function(){this.load(this.path)},parse:function(a){var b=this,c=this.tasks,d=a.split("\n");return d.each(function(a){var d=a[0];if("*"==d){var e=a.trim(),f=c.length;b.tagTable[e]=f}else if(";"==d||"/"==a[0]&&"/"==a[1]);else if("@"==d)c.push(b._makeTag(a.substr(1)));else{for(var g=!1,h="",i="",j=0;j<a.length;++j){var k=a[j];1==g?"]"==k?(c.push(b._makeTag(h)),h="",g=!1):h+=k:0==g&&"["==k?(""!=i&&(c.push({type:"text",value:i}),i=""),g=!0):i+=k}""!=i&&(c.push({type:"text",value:i}),i="")}}),console.log(c),this},_makeTag:function(a){var b=a.split(" "),c=b.shift(),d={};b.each(function(a){var b=a.split("="),c=b[0],e=b[1];return e.match(/^[+-]?[0-9]*[\.]?[0-9]+$/)?e=Number(e):"true"===e?e=!0:"false"===e&&(e=!1),d[c]=e});var e={type:"tag",func:c,params:d};return e}}),tm.define("tm.novel.Layer",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.images={}},addImage:function(a,b){this.images[a]=b,this.addChild(b)},getImage:function(a){return this.images[a]},removeImage:function(a){this.images[a].remove(),this.images[a]=null}});var BASIC_PROPS=["x","y","width","height","rotation","scaleX","scaleY","originX","originY","alpha"];tm.novel.TAG_MAP={l:function(){this.lock(),this.onpointingstart=function(){this.onpointingstart=null,this.unlock(),this.next()}.bind(this)},r:function(){this.labelArea.text+="\n",this.next()},cm:function(){this.labelArea.text="",this.next()},s:function(){this.finish()},base:function(){var a=this.activeTask.params;this.basePath=a.path.format(this.variables),this.next()},wait:function(){this.lock(),this.timeline.clear(),this.timeline.call(this.activeTask.params.time,function(){this.unlock(),this.next()}.bind(this))},alert:function(){console.log(this.activeTask.params.str),this.next()},position:function(){var a=this.activeTask.params,b=this.labelArea;void 0!==a.x&&(b.x=a.x),void 0!==a.y&&(b.y=a.y),void 0!==a.width&&(b.width=a.width),void 0!==a.height&&(b.height=a.height),a.vertical===!0&&(b.mode="vertical"),this.next()},font:function(){var a=this.activeTask.params,b=this.labelArea;void 0!==a.size&&(b.fontSize=a.size),void 0!==a.color&&(b.fillStyle=a.color),void 0!==a.face&&(b.fontFamily=a.face),void 0!==a.lineSpace&&(b.lineSpace=a.lineSpace),this.next()},load:function(){var a=this.activeTask.params,b=a.type||a.path.split(".").last;this.lock();var c=tm.asset.Loader();c.onload=function(){this.unlock(),this.next()}.bind(this);var d={},e=this.basePath?this.basePath+"/"+a.path:a.path;console.log(e),d[a.name]={path:e,type:b},c.load(d)},image_show:function(){var a=this.activeTask.params,b=tm.display.Sprite(a.name);this.addNovelElement(a.name,b,a.layer),void 0!==a.x&&(b.x=a.x),void 0!==a.y&&(b.y=a.y),void 0!==a.originX&&(b.originX=a.originX),void 0!==a.originY&&(b.originY=a.originY),void 0!==a.width&&(b.width=a.width),void 0!==a.height&&(b.height=a.height),b.show(),b.alpha=0,b.tweener.clear().fadeIn(250).call(function(){}),this.next()},image_hide:function(){var a=this.activeTask.params,b=this.getNovelElement(a.name);this.lock(),b.tweener.clear().fadeOut(250).call(function(){this.removeNovelElement(a.name),this.unlock(),this.next()}.bind(this))},delay:function(a){var b=this.activeTask.params;this.chSpeed=b.speed*(a.fps/1e3)|0,this.chSpeed=Math.max(this.chSpeed,1),this.next()},shape:function(){var a=this.activeTask.params,b=a.type,c=this.layers[a.layer||1],d=null;switch(b){case"rect":d=tm.display.RectangleShape(a.width,a.height,{strokeStyle:"transparent",fillStyle:a.color});break;default:console.log("そんなタイプないよ!")}c.addImage(a.name,d),d.x=a.x,d.y=a.y,d.alpha=0,d.tweener.clear().fadeIn(250),this.next()},jump:function(){var a=this.activeTask.params;this.jump(a.target)},call:function(){var a=this.activeTask.params;this.prevTaskIndex=this.taskIndex,this.jump(a.target)},"return":function(){this.set(this.prevTaskIndex+1)},reload:function(){this.lock(),this.script.reload(),this.script.onload=function(){this.unlock(),this.next()}.bind(this)},event:function(){var a=this.activeTask.params,b=tm.event.Event("novelevent");b.name=a.name,this.fire(b),this.next()},trace:function(){var params=this.activeTask.params;console.log(eval(params.exp)),this.next()},sound_play:function(){var a=this,b=this.activeTask.params,c=tm.asset.Manager.get(b.name).clone();b.wait===!0?(this.lock(),c.onended=function(){a.unlock(),a.next()}):this.next(),c.play()},music_play:function(){var a=this.activeTask.params;tm.asset.Manager.get(a.name).setLoop(!0).play(),this.next()},music_stop:function(){var a=this.activeTask.params;tm.asset.Manager.get(a.name).stop()},anim:function(){var a=this.activeTask.params,b=a.time||1e3,c=a.easing,d=this.getNovelElement(a.name),e=d.tweener,f={};BASIC_PROPS.each(function(b){void 0!==a[b]&&(f[b]=a[b])}),e.clear().to(f,b,c),this.next()},anim_by:function(){var a=this.activeTask.params,b=a.time||1e3,c=a.easing,d=this.getNovelElement(a.name),e=d.tweener,f={};BASIC_PROPS.each(function(b){void 0!==a[b]&&(f[b]=a[b])}),e.clear().by(f,b,c),this.next()},_argToArgs:function(a){if(void 0===a)return[];var b=a.split(",");return b.each(function(a,c){var d=a;d.match(/[^0-9]+/)?"true"===d?d=!0:"false"===d&&(d=!1):d=Number(d),b[c]=d}),b}},tm.novel.TAG_MAP.$extend({"new":function(){var a=this.activeTask.params,b=tm.using(a.type),c=tm.novel.TAG_MAP._argToArgs(a.arg),d=b.apply(null,c);this.addNovelElement(a.name,d,a.layer),BASIC_PROPS.each(function(b){var c=a[b];void 0!==c&&(d[b]=c)}),this.next()},set:function(){var a=this.activeTask.params,b=this.getNovelElement(a.name),c=a.key,d=a.value;c&&(b[c]=d),BASIC_PROPS.each(function(c){var d=a[c];void 0!==d&&(b[c]=d)}),this.next()},exec:function(){var a=this.activeTask.params,b=this.getNovelElement(a.name),c=tm.novel.TAG_MAP._argToArgs(a.arg);b[a.method].apply(b,c),this.next()},"delete":function(){{var a=this.activeTask.params;this.removeNovelElement(a.name)}this.next()}}),tm.novel.TAG_MAP.element_new=tm.novel.TAG_MAP.new,tm.novel.TAG_MAP.element_call=tm.novel.TAG_MAP.exec,tm.novel.TAG_MAP.element_remove=tm.novel.TAG_MAP.delete,tm.define("tm.novel.Element",{superClass:"tm.display.CanvasElement",elementMap:null,init:function(a){this.superInit(),this.script="string"==typeof a?tm.asset.Manager.get(a):a,this.layers={base:tm.novel.Layer().addChildTo(this),0:tm.novel.Layer().addChildTo(this),1:tm.novel.Layer().addChildTo(this),2:tm.novel.Layer().addChildTo(this),message0:tm.novel.Layer().addChildTo(this),message1:tm.novel.Layer().addChildTo(this)},this.taskIndex=0,this.lockFlag=!1,this.chSpeed=1,this.variables={},this.labelArea=tm.ui.LabelArea({text:"",width:430,height:200}).addChildTo(this.layers.message0),this.labelArea.text="",this.labelArea.origin.set(0,0),this.labelArea.x=20,this.labelArea.y=330,this.labelArea.fontSize=16,this.elementMap={},this.basePath="",this.set(0),this.setInteractive(!0),this.setBoundingType("all")},lock:function(){this.lockFlag=!0},unlock:function(){this.lockFlag=!1},jump:function(a){var b=this.script.tagTable[a];this.set(b)},set:function(a){if(this.taskIndex=a,this.activeTask=this.script.tasks[this.taskIndex],this.seek=0,!this.activeTask){var b=tm.event.Event("taskfinish");this.fire(b)}},next:function(){this.set(this.taskIndex+1)},finish:function(){this.set(this.script.tasks.length)},setVariable:function(a,b){return this.variables[a]=b,this},getVariable:function(a){return this.variables[a]},addNovelElement:function(a,b,c){void 0===c&&(c=1);var d=this.layers[c];return d.addChild(b),this.elementMap[a]=b,this},getNovelElement:function(a){var b=this.elementMap[a];return b},removeNovelElement:function(a){var b=this.elementMap[a];return b.remove(),this},updateTask:function(a){if(1!=this.lockFlag){var b=this.activeTask;if(b)if("text"==b.type){if(a.frame%this.chSpeed==0){var c=b.value[this.seek++];if(void 0!==c){if(this.labelArea.text+=c,a.pointing.getPointingStart()){for(var d=this.seek,e=b.value.length;e>d;++d){var c=b.value[d];this.labelArea.text+=c}this.next()}}else this.next();var f=tm.event.Event("textupdate");this.fire(f)}}else if("tag"==b.type){var g=tm.novel.TAG_MAP[b.func];console.assert(g,"don't define `{0}`!".format(b.func)),g.call(this,a);var f=tm.event.Event("taskrun");f.task=b,this.fire(f),this.updateTask(a)}else alert()}},update:function(a){this.updateTask(a)}});
tm.asset.Loader.register("ks",function(a){var b=tm.novel.Script(a);return b}),tm.define("tm.novel.Script",{superClass:"tm.event.EventDispatcher",loaded:!1,init:function(a){this.superInit(),this.tasks=[],a&&this.load(a)},load:function(a){tm.util.Ajax.load({url:a,dataType:"text",success:function(a){this.parse(a),this.loaded=!0,this.fire(tm.event.Event("load"))}.bind(this)})},parse:function(a){var b=this,c=this.tasks,d=a.split("\n");return d.each(function(a){var d=a[0];if("*"==d);else{for(var e=!1,f="",g="",h=0;h<a.length;++h){var i=a[h];1==e?"]"==i?(c.push(b._makeTag(f)),f="",e=!1):f+=i:0==e&&"["==i?(""!=g&&(c.push({type:"text",value:g}),g=""),e=!0):g+=i}""!=g&&c.push({type:"text",value:g})}}),console.log(c),this},_makeTag:function(a){var b=a.split(" "),c=b.shift(),d={};b.each(function(a){var b=a.split("="),c=b[0],e=b[1];return e.match(/[^0-9]+/)||(e=Number(e)),d[c]=e});var e={type:"tag",func:c,params:d};return e}}),tm.novel.TAG_MAP={l:function(a){a.pointing.getPointingStart()&&this.nextTask()},r:function(){this.label.text+="\n",this.nextTask()},cm:function(){this.label.text="",this.nextTask()},wait:function(a){0==this.waitFlag?(this.waitFlag=!0,this.waitTime=0):(this.waitTime+=1e3/a.fps,this.activeTask.params.time<=this.waitTime&&(this.waitFlag=!1,this.nextTask()))},alert:function(){alert(this.activeTask.params.str),this.nextTask()},position:function(){var a=this.activeTask.params;this.label.setPosition(a.x,a.y),this.nextTask()},image_new:function(){var a=this.activeTask.params;if(0==this.loadingFlag){this.loadingFlag=!0;var b=tm.asset.Loader();b.onload=function(){this.loadingFlag=!1,this.nextTask()}.bind(this),b.load(a.name,a.storage)}},image_show:function(){var a=this.activeTask.params,b=tm.display.Sprite(a.name).addChildTo(this);b.x=a.x,b.y=a.y,this.nextTask()}},tm.define("tm.novel.Element",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit(),this.script="string"==typeof a?tm.asset.Manager.get("sample"):a,this.waitFlag=!1,this.loadingFlag=!1,this.label=tm.display.Label().addChildTo(this),this.label.x=10,this.label.y=300,this.label.fontSize=16,this.nextTask()},nextTask:function(){this.activeTask=this.script.tasks.shift(),this.seek=0},update:function(a){var b=this.activeTask;if(b)if("text"==b.type){if(a.frame%2==0){var c=b.value[this.seek++];if(void 0!==c?this.label.text+=c:this.nextTask(),a.pointing.getPointingStart()){for(var d=this.seek,e=b.value.length;e>d;++d){var c=b.value[d];this.label.text+=c}this.nextTask()}}}else if("tag"==b.type){var f=tm.novel.TAG_MAP[b.func];f.call(this,a)}else alert()}});
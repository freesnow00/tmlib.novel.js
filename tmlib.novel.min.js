tm.asset.Loader.register("ks",function(a){var b=tm.novel.Script(a);return b}),tm.define("tm.novel.Script",{superClass:"tm.event.EventDispatcher",loaded:!1,init:function(a){this.superInit(),this.tasks=[],this.tagTable=[],a&&this.load(a)},load:function(a){this.loaded=!1,this.path=a,tm.util.Ajax.load({url:a,dataType:"text",success:function(a){this.parse(a),this.loaded=!0,this.fire(tm.event.Event("load"))}.bind(this)})},reload:function(){this.load(this.path)},parse:function(a){var b=this,c=this.tasks,d=a.split("\n");return d.each(function(a){var d=a[0];if("*"==d){var e=a.trim(),f=c.length;b.tagTable[e]=f}else if(";"==d);else if("@"==d)c.push(b._makeTag(a.substr(1)));else{for(var g=!1,h="",i="",j=0;j<a.length;++j){var k=a[j];1==g?"]"==k?(c.push(b._makeTag(h)),h="",g=!1):h+=k:0==g&&"["==k?(""!=i&&(c.push({type:"text",value:i}),i=""),g=!0):i+=k}""!=i&&c.push({type:"text",value:i})}}),console.log(c),this},_makeTag:function(a){var b=a.split(" "),c=b.shift(),d={};b.each(function(a){var b=a.split("="),c=b[0],e=b[1];return e.match(/[^0-9]+/)||(e=Number(e)),d[c]=e});var e={type:"tag",func:c,params:d};return e}}),tm.define("tm.novel.Layer",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.images={}},addImage:function(a,b){this.images[a]=b,this.addChild(b)},getImage:function(a){return this.images[a]},removeImage:function(a){this.images[a].remove(),this.images[a]=null}}),tm.novel.TAG_MAP={l:function(a){a.pointing.getPointingStart()&&this.next()},r:function(){this.label.text+="\n",this.next()},cm:function(){this.label.text="",this.next()},wait:function(a){0==this.waitFlag?(this.waitFlag=!0,this.waitTime=0):(this.waitTime+=1e3/a.fps,this.activeTask.params.time<=this.waitTime&&(this.waitFlag=!1,this.next()))},alert:function(){console.log(this.activeTask.params.str),this.next()},position:function(){var a=this.activeTask.params;this.label.setPosition(a.x,a.y),this.next()},image:function(){var a=this.activeTask.params;this.lock();var b=tm.asset.Loader();b.onload=function(){var b=tm.display.Sprite(a.storage);this.layers[a.layer].addChild(b),b.x=a.x,b.y=a.y,b.originX=void 0!==a.originX?a.originX:.5,b.originY=void 0!==a.originY?a.originY:.5,void 0!==a.width&&(b.width=a.width),void 0!==a.height&&(b.height=a.height),this.unlock(),this.next()}.bind(this),b.load(a.storage,a.storage)},image_new:function(){var a=this.activeTask.params,b=tm.asset.Loader();this.lock(),b.onload=function(){var b=tm.display.Sprite(a.name),c=this.layers[a.layer];c.addImage(a.name,b),b.hide(),this.unlock(),this.next()}.bind(this),b.load(a.name,a.storage)},image_show:function(){var a=this.activeTask.params,b=this.layers[a.layer],c=b.getImage(a.name);void 0!==a.x&&(c.x=a.x),void 0!==a.y&&(c.y=a.y),void 0!==a.originX&&(c.originX=a.originX),void 0!==a.originY&&(c.originY=a.originY),void 0!==a.width&&(c.width=a.width),void 0!==a.height&&(c.height=a.height),c.show(),c.alpha=0,c.tweener.clear().fadeIn(250),this.next()},image_hide:function(){var a=this.activeTask.params,b=this.layers[a.layer],c=b.getImage(a.name);c.tweener.clear().fadeOut(250).call(function(){c.hide()}.bind(this)),this.next()},delay:function(a){var b=this.activeTask.params;this.chSpeed=b.speed*(a.fps/1e3)|0,this.chSpeed=Math.max(this.chSpeed,1),this.next()},rect:function(){var a=this.activeTask.params,b=tm.display.RectangleShape(a.width,a.height,{strokeStyle:"transparent",fillStyle:a.color});this.layers[a.layer].addChild(b),b.x=a.x,b.y=a.y,this.next()},jump:function(){var a=this.activeTask.params;this.jump(a.target)},reload:function(){this.lock(),this.script.reload(),this.script.onload=function(){this.unlock(),this.next()}.bind(this)}},tm.define("tm.novel.Element",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit(),this.script="string"==typeof a?tm.asset.Manager.get(a):a,this.layers={base:tm.novel.Layer().addChildTo(this),0:tm.novel.Layer().addChildTo(this),1:tm.novel.Layer().addChildTo(this),2:tm.novel.Layer().addChildTo(this),message0:tm.novel.Layer().addChildTo(this),message1:tm.novel.Layer().addChildTo(this)},this.taskIndex=0,this.waitFlag=!1,this.lockFlag=!1,this.chSpeed=1,this.label=tm.display.Label().addChildTo(this.layers.message0),this.label.x=10,this.label.y=300,this.label.fontSize=16,this.next()},lock:function(){this.lockFlag=!0},unlock:function(){this.lockFlag=!1},jump:function(a){this.taskIndex=this.script.tagTable[a],this.next()},next:function(){this.activeTask=this.script.tasks[this.taskIndex++],this.seek=0},update:function(a){if(1!=this.lockFlag){var b=this.activeTask;if(b)if("text"==b.type){if(a.frame%this.chSpeed==0){var c=b.value[this.seek++];if(void 0!==c?this.label.text+=c:this.next(),a.pointing.getPointingStart()){for(var d=this.seek,e=b.value.length;e>d;++d){var c=b.value[d];this.label.text+=c}this.next()}}}else if("tag"==b.type){var f=tm.novel.TAG_MAP[b.func];f.call(this,a)}else alert()}}});